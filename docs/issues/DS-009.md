# DS-009: Mission Push to Device

**Type:** Task
**Phase:** 3 - Push
**Status:** Open
**Blocks:** None
**Blocked by:** DS-003, DS-005, DS-007, DS-008

## Summary

Implement the on-device equivalent of `tools/push_waypoints.py push` — select a local mission, pick a target device mission UUID, backup the existing KMZ, push the replacement to both locations, and verify file sizes.

## Push Workflow

1. User selects a local mission as source (from detail screen or push screen)
2. App loads device missions list via Shizuku
3. User picks target UUID (the device mission to replace)
4. Confirmation dialog: "Replace {UUID} ({N} waypoints by {author}) with {filename} ({M} waypoints)?"
5. On confirm:
   a. **Backup**: read existing KMZ from device → save to `{app_docs}/backups/{uuid}_{timestamp}.kmz`
   b. **Build**: generate KMZ bytes from local mission (or use stored raw bytes)
   c. **Push primary**: `writeFile('{WAYPOINT_ROOT}/{uuid}/{uuid}.kmz', bytes)`
   d. **Push temp**: `writeFile('{WAYPOINT_ROOT}/kmzTemp/{uuid}.kmz', bytes)`
   e. **Verify**: `fileSize()` on both paths matches `bytes.length`
6. Show result: success with size details, or error with specifics

## Screens & Widgets

### `lib/features/push/push_screen.dart`
- Source mission summary card (at top)
- Device missions list for target selection (radio buttons)
- Backup toggle (default: on)
- "Push" button (disabled until target selected)
- Confirmation dialog
- Progress dialog showing: Backing up... → Pushing primary... → Pushing temp... → Verifying...
- Result screen: success (with reminder to reload in DJI GoFly) or failure

### `lib/features/push/push_provider.dart`
- `pushMission(localMissionId, targetUuid, createBackup)` — orchestrates the full workflow
- Exposes `AsyncNotifier<PushState>` with states: idle, backing_up, pushing, verifying, success, error
- Uses `ShizukuChannel` for all device file operations

### `lib/features/push/widgets/device_target_picker.dart`
- Lists device missions as selectable cards
- Shows UUID (truncated), author, waypoint count
- Single selection (radio behavior)

## Device Paths

```
Primary: /sdcard/Android/data/dji.go.v5/files/waypoint/{UUID}/{UUID}.kmz
Temp:    /sdcard/Android/data/dji.go.v5/files/waypoint/kmzTemp/{UUID}.kmz
```

## Acceptance Criteria

- [ ] Push screen lists device missions for target selection
- [ ] Backup saves existing device KMZ to local app storage before overwriting
- [ ] Push writes KMZ to both primary and kmzTemp locations
- [ ] Size verification confirms both files match expected byte count
- [ ] Progress dialog shows each step
- [ ] Success message reminds user to reload mission in DJI GoFly
- [ ] Error handling: Shizuku disconnected, write failure, size mismatch
- [ ] Pushed KMZ loads correctly in DJI GoFly app

## Reference

- `tools/push_waypoints.py` `cmd_push()` function (lines 229-308) — exact logic to port
