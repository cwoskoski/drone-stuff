# DS-004: KMZ Parser and Data Models

**Type:** Task
**Phase:** 1 - Infrastructure
**Status:** Open
**Blocks:** DS-005, DS-007, DS-008, DS-009, DS-010
**Blocked by:** DS-002

## Summary

Implement KMZ parsing in Dart — extract ZIP, parse XML with dual-namespace support, and populate typed data models. This is a direct port of the logic in `tools/push_waypoints.py`.

## Data Models to Create

### `lib/core/models/mission.dart`
```dart
class Mission {
  final String id;
  final MissionConfig config;
  final List<Waypoint> waypoints;
  final String? author;
  final DateTime? createTime;
  final DateTime? updateTime;
  final Uint8List? rawKmzBytes;  // For round-trip fidelity
}
```

### `lib/core/models/mission_config.dart`
```dart
enum FinishAction { goHome, noAction, autoLand, backToFirstWaypoint }

class MissionConfig {
  final FinishAction finishAction;
  final String flyToWaylineMode;
  final String exitOnRCLost;
  final String executeRCLostAction;
  final double globalTransitionalSpeed;
  final int droneEnumValue;
  final int droneSubEnumValue;
}
```

### `lib/core/models/waypoint.dart`
```dart
class Waypoint {
  final int index;
  final double longitude, latitude;
  final double executeHeight;
  final double waypointSpeed;
  final WaypointHeading heading;
  final WaypointTurn turn;
  final bool useStraightLine;
  final List<ActionGroup> actionGroups;
  final GimbalHeading? gimbalHeading;
}
```

### `lib/core/models/action_group.dart`
```dart
class ActionGroup {
  final int groupId, startIndex, endIndex;
  final String mode, triggerType;
  final List<WaypointAction> actions;
}

class WaypointAction {
  final int actionId;
  final String actuatorFunc;  // "gimbalRotate", "takePhoto", etc.
  final Map<String, dynamic> params;
}
```

### `lib/core/models/device_mission.dart`
```dart
class DeviceMission {
  final String uuid;
  final int kmzSizeBytes;
  final String? author;
  final DateTime? createTime;
  final int waypointCount;
  final FinishAction? finishAction;
}
```

## Parser Files to Create

### `lib/core/kmz/kmz_parser.dart`
- Extract ZIP using `archive` package
- Find `wpmz/template.kml` and `wpmz/waylines.wpml`
- Validate required entries exist
- Delegate to template parser and wpml parser
- Return `Mission` model

### `lib/core/kmz/wpml_parser.dart` (most complex file)
- Parse `waylines.wpml` into `List<Waypoint>`
- **Dual-namespace support** — try both URIs, then fallback to local-name matching:
  - `http://www.dji.com/wpmz/1.0.6` (Litchi Hub)
  - `http://www.uav.com/wpmz/1.0.2` (DJI native)
- Parse all Placemark children: coordinates, executeHeight, waypointSpeed, heading params, turn params, action groups, gimbal params

### `lib/core/kmz/kml_template_parser.dart`
- Parse `template.kml` for metadata: author, createTime, updateTime
- Parse missionConfig: finishAction, flyToWaylineMode, speeds, droneInfo

### `lib/core/utils/xml_utils.dart`
- `findWpmlElement(parent, localName)` — namespace-aware lookup with fallback
- `findAllWpml(parent, localName)` — same but returns all matches
- Port of `_find_wpml_element()` from push_waypoints.py

### `lib/core/constants.dart`
- `WAYPOINT_ROOT = '/sdcard/Android/data/dji.go.v5/files/waypoint'`
- UUID regex pattern
- XML namespace URIs

## Acceptance Criteria

- [ ] `KmzParser.parseBytes()` on `docs/Havasu Lake Desert.kmz` returns Mission with:
  - 395 waypoints
  - author = "litchi-hub"
  - finishAction = goHome
  - createTime parsed correctly
- [ ] Parses all three split files (`_1`, `_2`, `_3`) correctly with 150, 150, 97 waypoints
- [ ] Each waypoint has valid lat/lon, altitude, speed, heading, and action groups
- [ ] Parser handles both namespace URIs (test with DJI-native and Litchi KMZ if available)
- [ ] Unit tests pass for parser using sample KMZ files as fixtures

## Reference

- `tools/push_waypoints.py` lines 133-227: Python parsing logic to port
- `docs/Havasu Lake Desert.kmz`: test fixture (395 waypoints, Litchi namespace)
