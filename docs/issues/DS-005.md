# DS-005: KMZ Writer

**Type:** Task
**Phase:** 1 - Infrastructure
**Status:** Open
**Blocks:** DS-009, DS-010
**Blocked by:** DS-004

## Summary

Implement KMZ writing in Dart — serialize a `Mission` model back to KMZ bytes (ZIP containing `wpmz/template.kml` and `wpmz/waylines.wpml`). Required for split, merge, and edit operations.

## Files to Create

### `lib/core/kmz/kmz_writer.dart`
- `buildKmz(Mission mission) → Uint8List` — full serialization from model
- `rewriteKmz(Uint8List original, {List<Waypoint>? waypoints, FinishAction? finishAction, double? speed}) → Uint8List` — modify original XML, preserving unknown elements
- Uses `archive` package for ZIP creation

### `lib/core/kmz/wpml_builder.dart`
- `buildWaylines(Mission mission) → String` — generate waylines.wpml XML
- Must produce all waypoint elements: coordinates, executeHeight, waypointSpeed, heading params, turn params, action groups, gimbal params
- Must use correct XML namespaces

### `lib/core/kmz/kml_template_builder.dart`
- `buildTemplate(Mission mission) → String` — generate template.kml XML
- Include author, createTime, updateTime, missionConfig

## Design: Round-Trip Fidelity

For **editing** existing missions, the safest approach is DOM modification rather than full reconstruction:

1. Parse the original KMZ's raw XML
2. Modify only the specific elements being changed (finishAction, speeds, etc.)
3. Re-serialize the modified DOM
4. Re-package into KMZ ZIP

This preserves any elements the app doesn't understand but DJI GoFly might depend on.

For **split** output where we're creating new wayline subsets, full XML generation from models is acceptable since we control all the content.

## Acceptance Criteria

- [ ] Round-trip test: parse KMZ → write KMZ → parse again → models match
- [ ] `rewriteKmz` with modified `finishAction` produces valid KMZ where only that element changed
- [ ] Generated KMZ contains both required entries (`wpmz/template.kml`, `wpmz/waylines.wpml`)
- [ ] Generated XML uses correct namespace declarations
- [ ] `tools/push_waypoints.py` can validate the generated KMZ (parse without errors)
- [ ] Written KMZ file sizes are reasonable (comparable to source)
