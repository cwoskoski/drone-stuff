# DS-003: Shizuku Platform Channel Bridge

**Type:** Task
**Phase:** 1 - Infrastructure
**Status:** Open
**Blocks:** DS-007, DS-009
**Blocked by:** DS-002

## Summary

Implement the Kotlin-side Shizuku integration that gives the Flutter app shell-level file access to DJI GoFly's scoped storage directory on Android 13+. This is the only Kotlin code in the project — a thin bridge between Flutter's MethodChannel and Shizuku's AIDL UserService.

## Platform Channel API

Channel name: `com.example.dronestuff/shizuku`

| Method | Args | Returns |
|---|---|---|
| `getShizukuState` | — | `String`: `not_installed`/`not_running`/`permission_needed`/`ready` |
| `requestShizukuPermission` | — | `bool` |
| `listFiles` | `{path: String}` | `List<String>` |
| `readFile` | `{path: String}` | `Uint8List` |
| `writeFile` | `{path: String, bytes: Uint8List}` | `bool` |
| `fileSize` | `{path: String}` | `int` (-1 if missing) |
| `exists` | `{path: String}` | `bool` |
| `deleteFile` | `{path: String}` | `bool` |

## Files to Create

### Kotlin (Android side)

1. **`android/app/src/main/aidl/com/example/dronestuff/IFileService.aidl`**
   - AIDL interface with `listFiles`, `readFile`, `writeFile`, `fileSize`, `exists`, `deleteFile`, `destroy`

2. **`android/app/src/main/kotlin/.../ShizukuFileService.kt`**
   - `IFileService.Stub` implementation
   - Runs as shell UID 2000 (has access to `/sdcard/Android/data/`)
   - Uses standard `java.io.File` APIs
   - No-arg constructor (Shizuku requirement)
   - `destroy()` calls `System.exit(0)`

3. **`android/app/src/main/kotlin/.../ShizukuMethodChannel.kt`**
   - MethodChannel handler dispatching all 8 methods
   - Manages Shizuku lifecycle: binder listeners, permission requests, UserService binding
   - Auto-binds UserService when Shizuku permission is granted

4. **`android/app/src/main/kotlin/.../MainActivity.kt`**
   - FlutterActivity subclass
   - Registers MethodChannel in `configureFlutterEngine()`
   - Cleans up in `onDestroy()`

### Manifest + Gradle

5. **`AndroidManifest.xml`** — add Shizuku provider:
   ```xml
   <provider
       android:name="rikka.shizuku.ShizukuProvider"
       android:authorities="${applicationId}.shizuku"
       android:multiprocess="false" android:enabled="true"
       android:exported="true"
       android:permission="android.permission.INTERACT_ACROSS_USERS_FULL" />
   ```

6. **`android/app/build.gradle.kts`** — add Shizuku deps:
   ```kotlin
   implementation("dev.rikka.shizuku:api:13.1.5")
   implementation("dev.rikka.shizuku:provider:13.1.5")
   ```

### Dart (Flutter side)

7. **`lib/core/platform/shizuku_channel.dart`**
   - Dart wrapper class with async methods for all 8 platform channel calls
   - Error handling (PlatformException → typed errors)

8. **`lib/core/platform/shizuku_state.dart`**
   - `ShizukuState` enum with display messages
   - Riverpod provider that polls/watches Shizuku state

## Acceptance Criteria

- [ ] `getShizukuState()` returns correct state on a device with Shizuku installed and running
- [ ] `requestShizukuPermission()` triggers the Shizuku permission dialog
- [ ] After granting permission, `listFiles('/sdcard/Android/data/dji.go.v5/files/waypoint/')` returns directory entries including the UUID folder
- [ ] `readFile` successfully reads a KMZ from the DJI directory
- [ ] `writeFile` successfully writes a file to the DJI directory
- [ ] `fileSize` returns correct byte count
- [ ] Service reconnects gracefully if Shizuku is restarted

## Notes

- Binder transaction limit is ~1MB; KMZ files are typically 10-200KB, well within limits
- Shizuku must be re-activated after device reboot (unless root-started)
- The `ShizukuSetupBanner` UI is in DS-007, not here — this issue is just the platform bridge
