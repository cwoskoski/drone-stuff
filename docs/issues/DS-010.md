# DS-010: Mission Split/Merge/Edit with finishAction Control

**Type:** Task
**Phase:** 4 - Split/Edit
**Status:** Open
**Blocks:** None
**Blocked by:** DS-004, DS-005, DS-008

## Summary

Implement the core feature that motivated this app: splitting long missions into battery-sized segments with per-segment `finishAction` control, merging segments back together, and editing mission properties.

## Why This Matters

When flying a 395-waypoint mission that exceeds battery capacity, it must be split into segments. The critical behavior is:
- **Intermediate segments**: `finishAction=noAction` (drone hovers at last waypoint, pilot swaps missions)
- **Final segment**: `finishAction=goHome` (drone returns home after last waypoint)

Without this control, every segment triggers RTH, wasting battery flying home and back to the route.

## Split Feature

### Split Algorithm
```
Input:  395 waypoints, waypointsPerSegment=150, overlap=1
Output: Segment 1: WP 0-149   (150 wpts, finishAction=noAction)
        Segment 2: WP 149-298 (150 wpts, finishAction=noAction)
        Segment 3: WP 298-394 (97 wpts,  finishAction=goHome)
```

Key details:
- **Overlap**: 1 waypoint repeated at segment boundaries for flight continuity
- **Re-indexing**: each segment's waypoints re-indexed from 0
- **ActionGroup fixup**: `startIndex`/`endIndex` remapped to new local indices
- **finishAction per segment**: user-configurable, smart defaults

### `lib/features/split_merge/split/split_screen.dart`
- Input: mission to split (from detail screen)
- Config form:
  - Waypoints per segment (slider/text, default: 150)
  - Overlap count (0-3, default: 1)
  - Per-segment finishAction selector (defaults: noAction for intermediate, goHome for last)
- Preview:
  - Number of segments, waypoint ranges per segment
  - Color-coded map preview (each segment a different color polyline)
- "Split" button → creates N new KMZ files saved locally

### `lib/features/split_merge/split/split_provider.dart`
- `MissionSplitter.split(Mission source, SplitConfig config) → List<Mission>`
- For each segment:
  1. Extract waypoint sublist with overlap
  2. Re-index from 0
  3. Remap ActionGroup start/endIndex
  4. Apply segment-specific finishAction
  5. Generate KMZ via `KmzWriter`
- Save all segments to local storage via `LocalMissionRepository`
- Link segments to parent via `parent_mission_id` and `segment_index`

### `lib/features/split_merge/split/split_preview_screen.dart`
- Reuses `WaypointMapView` from DS-008
- Multiple colored polylines (one per segment)
- Overlap waypoints highlighted
- Segment boundaries marked with larger markers
- Legend showing segment colors and finishAction for each

## Merge Feature

### `lib/features/split_merge/merge/merge_screen.dart`
- Select multiple local missions (ordered) to merge
- Preview: combined waypoint count, total route on map
- Handle overlap removal at merge boundaries (detect and dedupe shared waypoints)
- Use first mission's config as base (or let user choose)
- Save merged result as new local mission

### `lib/features/split_merge/merge/merge_provider.dart`
- `MissionMerger.merge(List<Mission>, {int overlap}) → Mission`
- Concatenate waypoint lists, removing `overlap` duplicate waypoints at boundaries
- Re-index waypoints from 0
- Remap ActionGroup indices

## Edit Feature

### `lib/features/edit/edit_mission_screen.dart`
- Edit properties of a local mission (non-destructive — creates new copy)
- Editable fields:
  - **finishAction** — dropdown (this is the key feature)
  - **globalTransitionalSpeed** — number input
  - **autoFlightSpeed** — number input
  - **All waypoint speeds** — bulk "set all to X" + individual override
  - **All waypoint altitudes** — bulk "set all to X" + individual override
- Preview changes before saving

### `lib/features/edit/edit_mission_provider.dart`
- Uses `KmzWriter.rewriteKmz()` for DOM-level modification (preserves unknown elements)
- Saves as new mission with `source_type = 'edited'` and link to original
- Original mission is preserved unchanged

### `lib/features/edit/widgets/finish_action_selector.dart`
- Prominent dropdown/segmented control for FinishAction
- Color-coded: green=goHome, amber=noAction, blue=autoLand
- Shows description: "Drone returns home" / "Drone hovers at last waypoint"

## Acceptance Criteria

### Split
- [ ] Split 395-waypoint mission into 3 segments (150/150/97) with 1 overlap
- [ ] Intermediate segments have `finishAction=noAction`
- [ ] Final segment has `finishAction=goHome`
- [ ] Each segment's waypoints are re-indexed from 0
- [ ] ActionGroup indices are correctly remapped
- [ ] Map preview shows color-coded segments
- [ ] Split segments appear in local missions list, linked to parent
- [ ] Each segment KMZ passes validation (parseable, correct waypoint count)
- [ ] Push individual segments to device — loads correctly in DJI GoFly

### Merge
- [ ] Merge 3 segments back into single mission
- [ ] Overlap waypoints deduplicated at boundaries
- [ ] Merged mission has correct total waypoint count
- [ ] Waypoints re-indexed sequentially

### Edit
- [ ] Change finishAction from goHome to noAction → saved KMZ reflects change
- [ ] Bulk speed change applied to all waypoints
- [ ] Original mission preserved (edit creates new copy)
- [ ] Edited KMZ valid and parseable

## Reference

- Existing split files (`docs/Havasu Lake Desert_{1,2,3}.kmz`) — validate split output matches this pattern
- Split analysis: file 1 first WP matches file 2 last WP (overlap confirmed)
