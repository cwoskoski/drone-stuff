# DS-006: Drift Database + Local Mission Repository

**Type:** Task
**Phase:** 1 - Infrastructure
**Status:** Open
**Blocks:** DS-007
**Blocked by:** DS-002, DS-004

## Summary

Set up Drift (SQLite ORM) for local mission metadata storage and implement the local mission repository that manages imported KMZ files in app-specific storage.

## Database Schema

### `missions` table
| Column | Type | Description |
|---|---|---|
| `id` | TEXT PK | UUID |
| `file_name` | TEXT | Original import filename |
| `author` | TEXT | From template.kml |
| `create_time` | INTEGER | Mission creation timestamp (millis) |
| `waypoint_count` | INTEGER | Number of waypoints |
| `finish_action` | TEXT | goHome, noAction, etc. |
| `file_path` | TEXT | Relative path in app documents dir |
| `imported_at` | INTEGER | When user imported it |
| `source_type` | TEXT | `imported`, `split`, `merged`, `edited` |
| `parent_mission_id` | TEXT? | For split segments, links to parent |
| `segment_index` | INTEGER? | Segment number (1, 2, 3...) |

## Files to Create

### `lib/core/database/tables/missions_table.dart`
- Drift table definition for `missions`

### `lib/core/database/app_database.dart`
- Drift database class with `missions` table
- Version 1 schema

### `lib/core/database/daos/mission_dao.dart`
- `getAllMissions()` → `Stream<List<MissionEntity>>`
- `getMissionById(id)` → `Future<MissionEntity?>`
- `insertMission(entity)` → `Future<void>`
- `deleteMission(id)` → `Future<void>`
- `getSegments(parentId)` → `Stream<List<MissionEntity>>`

### `lib/features/missions/local/local_mission_repository.dart`
- `importKmz(Uint8List bytes, String fileName)` — parse, store KMZ file in app docs dir, insert metadata into DB
- `getMission(id)` — load metadata + KMZ bytes
- `deleteMission(id)` — remove from DB and filesystem
- `saveSplitSegment(parentId, segmentIndex, Mission, Uint8List kmzBytes)` — for split output

## Storage Layout

```
{app documents dir}/
├── missions/
│   ├── {uuid1}.kmz
│   ├── {uuid2}.kmz
│   └── ...
└── backups/
    └── {target-uuid}_{timestamp}.kmz
```

## Acceptance Criteria

- [ ] `dart run build_runner build` generates Drift code without errors
- [ ] Import a KMZ → metadata appears in DB, file stored in app docs
- [ ] Query returns correct mission list ordered by import time
- [ ] Delete removes both DB entry and file
- [ ] Split segments link to parent via `parent_mission_id`
- [ ] App restart preserves all data
